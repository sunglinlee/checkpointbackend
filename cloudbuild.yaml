steps:
  # 步驟 1: 檢查是否需要部署 (檢查檔案變更 或 commit message)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        echo "=== Checking for conditions to deploy ==="
        echo "Current commit: $COMMIT_SHA"
        
        # 預設為不部署
        SHOULD_DEPLOY=false
        
        # 設定 git 配置，以便讀取 commit message
        git config --global --add safe.directory /workspace
        COMMIT_MESSAGE=$$(git log -1 --pretty=%B)

        # 檢查 commit message 是否包含 [force deploy]
        if echo "$$COMMIT_MESSAGE" | grep -q "\[force deploy\]"; then
          echo "Found '[force deploy]' in commit message. Forcing deployment."
          SHOULD_DEPLOY=true
        else
          echo "Commit message does not contain force flag. Checking for file changes..."
          
          # 獲取上一次成功部署的 commit SHA
          LAST_SHA=$$(gcloud run services describe ${_SERVICE_NAME} \
            --region=${_REGION} \
            --format="value(metadata.annotations.\"run.googleapis.com/commit-sha\")" \
            2>/dev/null || echo "")
          
          if [ -z "$$LAST_SHA" ]; then
            echo "No previous deployment found, proceeding with full deployment."
            SHOULD_DEPLOY=true
          else
            echo "Last deployed SHA: $$LAST_SHA"
            CHANGED_FILES=$$(git diff --name-only $$LAST_SHA..$COMMIT_SHA 2>/dev/null || echo "all")
            
            # 檢查是否有相關變更
            if echo "$$CHANGED_FILES" | grep -qE "^src/|^pom.xml|^Dockerfile|(\.(yml|yaml|properties))$$"; then
              echo "Found changes in relevant files. Will proceed with deployment."
              SHOULD_DEPLOY=true
            fi
          fi
        fi

        if [ "$$SHOULD_DEPLOY" = true ]; then
          echo "DEPLOY=true" > /workspace/deploy_decision.env
          echo "Decision: Proceeding with deployment."
        else
          echo "DEPLOY=false" > /workspace/deploy_decision.env
          echo "Decision: No relevant changes detected, skipping deployment."
        fi
    env:
      - 'CLOUDSDK_CORE_DISABLE_PROMPTS=1'

  # 後續步驟與您原先的檔案相同，只是加上了條件判斷
  # 步驟 2: 條件性建置容器映像檔
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/deploy_decision.env
        if [ "$$DEPLOY" = "true" ]; then
          echo "Building Docker image..."
          docker build -t ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$COMMIT_SHA .
        else
          echo "Skipping Docker build."
        fi

  # 步驟 3: 條件性推送映像檔
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/deploy_decision.env
        if [ "$$DEPLOY" = "true" ]; then
          echo "Pushing Docker image..."
          gcloud auth configure-docker ${_REGION}-docker.pkg.dev -q
          docker push ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$COMMIT_SHA
        else
          echo "Skipping Docker push."
        fi

  # 步驟 4: 條件性部署到 Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        source /workspace/deploy_decision.env
        if [ "$$DEPLOY" = "true" ]; then
          echo "Deploying to Cloud Run..."
          gcloud run deploy ${_SERVICE_NAME} \
            --image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$COMMIT_SHA \
            --region=${_REGION} \
            --service-account=${_SERVICE_ACCOUNT_EMAIL} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${_DB_INSTANCE_CONNECTION_NAME} \
            --set-env-vars="DB_NAME=${_DB_NAME},DB_USER=${_DB_USER}" \
            --set-secrets="DB_PASSWORD=${_DB_SECRET_NAME}:latest" \
            --update-annotations="run.googleapis.com/commit-sha=$COMMIT_SHA"
        else
          echo "Skipping Cloud Run deployment."
        fi
    env:
      - 'CLOUDSDK_CORE_DISABLE_PROMPTS=1'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 100

substitutions:
  _SERVICE_NAME: checkpoint-backend
  _REGION: asia-east1
  _REPOSITORY: checkpoint2cicd
  _IMAGE_NAME: checkpoint-be
  _DB_INSTANCE_CONNECTION_NAME: civil-hash-468807-a8:asia-east1:checkpointdb1709
  _SERVICE_ACCOUNT_EMAIL: checkpoint-be2db@civil-hash-468807-a8.iam.gserviceaccount.com
  _DB_NAME: checkpoint_db
  _DB_USER: checkpointdb1709
  _DB_SECRET_NAME: CheckPointSM